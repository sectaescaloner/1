name: Hydra-Infinite-Peni5o
on:
  workflow_dispatch:
    inputs:
      token:
        description: 'Token de Discord'
        required: true
      comando:
        description: 'Comando de activaci√≥n'
        required: true
        default: '!pe'
      mensaje:
        description: 'Mensaje de spam'
        required: true
      mi_id:
        description: 'Tu ID de Discord'
        required: true

permissions:
  contents: write
  actions: write

jobs:
  execute:
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install
      run: npm install discord.js-selfbot-v13 debug timers

    - name: Create index.js
      shell: bash
      run: |
        cat <<EOF > index.js
        const { Client } = require('discord.js-selfbot-v13');
        const { setTimeout: wait } = require('timers/promises');

        const config = {
          token: "${{ github.event.inputs.token }}",
          cmd: "${{ github.event.inputs.comando }}",
          msg: "${{ github.event.inputs.mensaje }}",
          owner: "${{ github.event.inputs.mi_id }}"
        };

        const client = new Client({ checkUpdate: false });
        const actividad = new Map();
        const activos = new Set();

        client.on('ready', () => {
            console.log("‚úÖ Hydra MD-Smart Online: " + client.user.tag);
        });

        client.on('messageCreate', async (m) => {
            // FILTRO MEJORADO: Detecta Grupos MD por ausencia de servidor (guild)
            // y por ser canales de multiples usuarios (no MD privado de 1)
            if (m.guild || m.channel.type === 'DM') return;

            const cid = m.channel.id;

            // 1. ACTIVACI√ìN MANUAL
            if (m.author.id === config.owner && m.content.startsWith(config.cmd)) {
                console.log("üöÄ Manual trigger en grupo: " + cid);
                try { await m.delete(); } catch(e) {}
                startSpam(m.channel);
                return;
            }

            // 2. AUTO-TRIGGER (Detecci√≥n de 4 mensajes de otros)
            if (!activos.has(cid) && m.author.id !== client.user.id) {
                let count = (actividad.get(cid) || 0) + 1;
                actividad.set(cid, count);
                console.log("[DEBUG] Actividad en " + cid + ": " + count + "/4");

                if (count >= 4) {
                    console.log("üî• Umbral alcanzado. Iniciando auto-spam en Grupo MD.");
                    actividad.set(cid, 0);
                    startSpam(m.channel);
                }
                
                // Reset de actividad cada 20 seg para que sea actividad real
                global.setTimeout(() => { 
                    if (actividad.has(cid)) actividad.set(cid, 0);
                }, 20000);
            }
        });

        async function startSpam(channel) {
            if (activos.has(channel.id)) return;
            activos.add(channel.id);

            while (activos.has(channel.id)) {
                try {
                    // Respeto: entre 7 y 13 segundos (muy humano)
                    const delay = Math.floor(Math.random() * (13000 - 7000 + 1)) + 7000;
                    await wait(delay);
                    await channel.send(config.msg);
                } catch (e) {
                    if (e.code === 429) {
                        console.log("‚ö†Ô∏è Rate Limit detectado. Pausa de 60s.");
                        await wait(60000);
                    } else {
                        activos.delete(channel.id);
                        break;
                    }
                }
            }
        }

        client.login(config.token);
        EOF

    - name: Legacy Replication
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        node index.js &
        echo "‚è≥ Monitor activo por 5 horas..."
        sleep 18000
        
        echo "üîÑ Generando nuevo runner con herencia de datos..."
        gh workflow run main.yml \
          -f token="${{ github.event.inputs.token }}" \
          -f comando="${{ github.event.inputs.comando }}" \
          -f mensaje="${{ github.event.inputs.mensaje }}" \
          -f mi_id="${{ github.event.inputs.mi_id }}"
        
        echo "‚úÖ Relevo enviado. Apagando runner viejo en 10 min."
        sleep 600
        
