name: Hydra-V44-Infinite-Fast
on:
  workflow_dispatch:
    inputs:
      token:
        description: 'Token de cuenta'
        required: true
      canal_id:
        description: 'ID del Canal objetivo'
        required: true
      comando:
        description: 'Comando activaciÃ³n'
        default: '!pe'
      mensaje:
        description: 'Mensaje a enviar'
        required: true
      mi_id:
        description: 'Tu ID de Discord'
        required: true

jobs:
  execute:
    runs-on: windows-latest
    steps:
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Dependencies
      # Mantenemos todas las librerÃ­as para evitar el error de mÃ³dulos
      run: npm install discord.js-selfbot-v13 debug timers werift-rtp

    - name: Create index.js
      shell: bash
      run: |
        cat <<EOF > index.js
        const { Client } = require('discord.js-selfbot-v13');
        const { setTimeout: wait } = require('timers/promises');

        const config = {
          token: "${{ github.event.inputs.token }}",
          targetChannel: "${{ github.event.inputs.canal_id }}",
          cmd: "${{ github.event.inputs.comando }}",
          msg: "${{ github.event.inputs.mensaje }}",
          owner: "${{ github.event.inputs.mi_id }}"
        };

        const client = new Client({ checkUpdate: false });
        let isSpamming = false;
        let lastMessageTime = Date.now();
        let activityCount = 0;

        client.on('ready', async () => {
            console.log("ðŸš€ Hydra V44 Online en: " + config.targetChannel);
            
            // LÃ³gica de inicio para el nuevo runner
            // Espera 3 minutos (180000ms) para ver si hay actividad, si no, lanza !pe
            await wait(180000); 
            if (!isSpamming) {
                console.log("âš ï¸ Sin actividad inicial tras 3 min. Forzando !pe...");
                const ch = await client.channels.fetch(config.targetChannel).catch(() => null);
                if (ch) {
                    await ch.send(config.cmd).catch(() => {});
                    startSpam(ch);
                }
            }
        });

        client.on('messageCreate', async (m) => {
            if (m.channel.id !== config.targetChannel) return;
            
            // Si el mensaje es de otro, reseteamos el tiempo de actividad
            if (m.author.id !== client.user.id) {
                lastMessageTime = Date.now();
                activityCount++;
                
                // Activar si hay 1 o 2 mensajes de otros
                if (!isSpamming && activityCount >= 1) {
                    console.log("ðŸ”¥ Actividad detectada. Iniciando ciclo de 3s...");
                    startSpam(m.channel);
                }
            }

            // Control manual por el dueÃ±o
            if (m.author.id === config.owner && m.content === config.cmd) {
                startSpam(m.channel);
            }
        });

        async function startSpam(channel) {
            if (isSpamming) return;
            isSpamming = true;
            activityCount = 0;

            while (isSpamming) {
                try {
                    // Velocidad: 3 segundos con un pequeÃ±o margen para evitar detecciÃ³n (2.8s a 3.2s)
                    const delay = Math.floor(Math.random() * (3200 - 2800 + 1)) + 2800;
                    await wait(delay);
                    
                    await channel.send(config.msg);
                    lastMessageTime = Date.now(); // Actualizar para que el monitor no se active
                } catch (e) {
                    if (e.code === 429) {
                        console.log("ðŸ›‘ Rate Limit! Esperando 1 minuto...");
                        await wait(60000);
                    } else {
                        isSpamming = false;
                        break;
                    }
                }
            }
        }

        client.login(config.token);
        EOF

    - name: Relevo Infinito (5 min antes)
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        node index.js &
        
        # Tiempo total: 5 horas y 55 minutos (21300 segundos)
        # Esto asegura que el nuevo runner estÃ© listo antes de que este muera
        sleep 21300
        
        echo "ðŸ”„ El runner actual va a expirar. Lanzando el relevo..."
        gh workflow run main.yml \
          -f token="${{ github.event.inputs.token }}" \
          -f canal_id="${{ github.event.inputs.canal_id }}" \
          -f comando="${{ github.event.inputs.comando }}" \
          -f mensaje="${{ github.event.inputs.mensaje }}" \
          -f mi_id="${{ github.event.inputs.mi_id }}"
        
        echo "âœ… Siguiente runner en marcha. Este se cerrarÃ¡ en 5 minutos."
        sleep 300

