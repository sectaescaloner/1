name: RDP_NGROK_POWER_FIX
on: workflow_dispatch

jobs:
  deploy:
    runs-on: windows-latest
    steps:
      - name: 1. SETUP RDP
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          net user boosito Parinuxd123 /add
          net localgroup administrators boosito /add

      - name: 2. INSTALAR NGROK
        shell: powershell
        run: |
          choco install ngrok -y
          ngrok authtoken 393CwGNqE4jpyhdAuvNewGtG58B_5roLoskHKD1jLw4CCigti

      - name: 3. INICIAR TUNEL
        shell: powershell
        run: |
          Write-Host "Lanzando Ngrok..."
          Start-Process -FilePath "ngrok" -ArgumentList "tcp", "3389"
          # Esperamos lo suficiente para que la red sincronice
          Start-Sleep -Seconds 30

      - name: 4. DIRECCION FINAL (CON REINTENTO)
        shell: powershell
        run: |
          $maxRetries = 5
          for ($i = 1; $i -le $maxRetries; $i++) {
              try {
                  $json = curl.exe -s http://localhost:4040/api/tunnels | ConvertFrom-Json
                  if ($json.tunnels.Count -gt 0) {
                      $url = $json.tunnels[0].public_url
                      $clean = $url.Replace("tcp://", "")
                      Write-Host "DIRECCION_RDP: $clean"
                      Write-Host "USUARIO: boosito"
                      Write-Host "CLAVE: Parinuxd123"
                      return
                  }
              } catch {}
              Write-Host "Esperando tunnel... Intento $i"
              Start-Sleep -Seconds 5
          }
          Write-Error "No se pudo obtener la URL de Ngrok tras varios intentos."

      - name: 5. LOOP
        shell: powershell
        run: |
          Write-Host "RUNNER_LISTO"
          while($true) { Start-Sleep 60 }
          
