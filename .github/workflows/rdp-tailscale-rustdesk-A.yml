name: RDP_NGROK_FINAL_V3
on: workflow_dispatch

jobs:
  deploy:
    runs-on: windows-latest
    steps:
      - name: 1. CONFIG RDP
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          net user boosito Parinuxd123 /add
          net localgroup administrators boosito /add

      - name: 2. INSTALAR NGROK
        shell: powershell
        run: |
          choco install ngrok -y
          # Usamos la ruta completa del shim de choco para el token
          & "C:\ProgramData\chocolatey\bin\ngrok.exe" authtoken 393CwGNqE4jpyhdAuvNewGtG58B_5roLoskHKD1jLw4CCigti

      - name: 3. INICIAR TUNEL Y CAPTURAR LOG
        shell: powershell
        run: |
          Write-Host "Iniciando tunel con log de depuracion..."
          # Lanzamos con la ruta completa y volcamos errores a un archivo
          Start-Process -FilePath "C:\ProgramData\chocolatey\bin\ngrok.exe" -ArgumentList "tcp", "3389", "--log", "stdout" -RedirectStandardOutput "ngrok.log"
          Start-Sleep -Seconds 30

      - name: 4. OBTENER DIRECCION O VER ERROR
        shell: powershell
        run: |
          $json = curl.exe -s http://localhost:4040/api/tunnels | ConvertFrom-Json
          if ($json.tunnels.Count -gt 0) {
              $url = $json.tunnels[0].public_url.Replace("tcp://", "")
              Write-Host "========================================"
              Write-Host "üîó CONECTATE AQUI: $url"
              Write-Host "üë§ USER: boosito"
              Write-Host "üîë PASS: Parinuxd123"
              Write-Host "========================================"
          } else {
              Write-Host "‚ùå ERROR: El tunel no inicio. Mostrando log de Ngrok:"
              Get-Content "ngrok.log" # Esto nos dira el error real de Ngrok
          }

      - name: 5. LOOP
        shell: powershell
        run: |
          while($true) { Start-Sleep 60 }
          
