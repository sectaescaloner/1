name: RDP_TAILSCALE_FINAL
on:
  workflow_dispatch:
    inputs:
      tailscale_authkey:
        description: 'Pega tu Auth Key de Tailscale aqui'
        required: true

jobs:
  deploy:
    runs-on: windows-latest
    steps:
      - name: 1. CONFIGURAR RDP
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          net user boosito Parinuxd123 /add
          net localgroup administrators boosito /add

      - name: 2. INSTALAR TAILSCALE (FIXED)
        shell: powershell
        run: |
          # Descarga directa de la version x64 estable
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-full-latest.exe"
          curl.exe -L -o tailscale-setup.exe $url
          
          Write-Host "Instalando Tailscale de forma silenciosa..."
          Start-Process -FilePath .\tailscale-setup.exe -ArgumentList "/quiet", "/norestart" -Wait
          
          Write-Host "Conectando a Tailscale..."
          $authkey = "${{ github.event.inputs.tailscale_authkey }}"
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey $authkey

      - name: 3. DESCARGAR REMOTELY (MIRILLIS)
        shell: powershell
        run: |
          $url = "https://downloads.mirillis.com/files/remote_1_3_0_setup.exe"
          $dest = "$env:USERPROFILE\Downloads\remotely_setup.exe"
          curl.exe -L -o $dest $url
          Write-Host "Remotely listo en Downloads"

      - name: 4. INFO FINAL
        shell: powershell
        run: |
          $ip = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4)
          Write-Host "========================================"
          Write-Host "IP PARA WINDOWS APP: $ip"
          Write-Host "USER: boosito"
          Write-Host "PASS: Parinuxd123"
          Write-Host "========================================"

      - name: 5. LOOP
        shell: powershell
        run: |
          while($true) { Start-Sleep 60 }

