name: RDP_PLAYIT_IP_LOG
on: workflow_dispatch

jobs:
  deploy:
    runs-on: windows-latest
    steps:
      - name: 1. SETUP RDP
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          net user boosito Parinuxd123 /add
          net localgroup administrators boosito /add

      - name: 2. EJECUTAR TUNEL Y EXTRAER IP
        shell: powershell
        run: |
          # Descargar Playit
          curl.exe -L -o playit.exe "https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-windows-x86_64.exe"
          
          # Lanzar playit y volcar TODO el texto a un archivo de log
          Start-Process -FilePath .\playit.exe -ArgumentList "--no-auth", "--p", "3389", "--proto", "tcp" -RedirectStandardOutput "playit.log"
          
          Write-Host "Esperando a que Playit genere la direccion..."
          Start-Sleep -Seconds 30
          
          # Leer el log y buscar la linea del tunel o del reclamo
          $log = Get-Content "playit.log"
          $log | Select-String "tunnel" | ForEach-Object { Write-Host "DIRECCION ENCONTRADA: $($_.ToString())" }
          $log | Select-String "claim" | ForEach-Object { Write-Host "URL DE RECLAMO: $($_.ToString())" }
          
          Write-Host "----------------------------------------"
          Write-Host "USER: boosito"
          Write-Host "PASS: Parinuxd123"
          Write-Host "----------------------------------------"

      - name: 3. MANTENER VIVO
        shell: powershell
        run: |
          while($true) { 
            Write-Host "Runner Activo - $(Get-Date)"
            Start-Sleep -Seconds 60 
          }

