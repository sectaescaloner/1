name: üêÄ RATA_SUNSHINE_TAILSCALE_V8
on: 
  workflow_dispatch:
    inputs:
      tailscale_key:
        description: 'Tu Auth Key de Tailscale'
        required: true

jobs:
  gaming-heist:
    runs-on: windows-latest
    steps:
      - name: üèéÔ∏è 1. RAM 32GB (M√âTODO REGISTRO)
        shell: powershell
        run: |
          reg add "HKLM\System\CurrentControlSet\Control\Session Manager\Memory Management" /v PagingFiles /t REG_MULTI_SZ /d "D:\pagefile.sys 32768 32768" /f
          Write-Host "[OK] RAM preparada."

      - name: üëÅÔ∏è 2. INSTALAR MONITOR VIRTUAL (LINK DIRECTO)
        shell: powershell
        run: |
          $url = "https://github.com/VirtualDrivers/Virtual-Display-Driver/releases/download/25.5.2/Virtual.Display.Driver-v25.05.03-setup-x64.exe"
          # Usamos curl.exe con la ruta completa para que Windows no use el alias falso
          & curl.exe -L -o setup_monitor.exe $url
          if (Test-Path "setup_monitor.exe") {
              Start-Process -FilePath ".\setup_monitor.exe" -ArgumentList "/S" -Wait
              Write-Host "[OK] Monitor instalado."
          } else {
              Write-Error "Fallo la descarga del driver."
          }

      - name: üöá 3. TAILSCALE (SALTO DE FIREWALL)
        shell: powershell
        run: |
          choco install tailscale -y
          # Conectamos con tu Key para que la VM aparezca en tu celular
          & "C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\WindowsApps\tailscale.exe" up --authkey ${{ github.event.inputs.tailscale_key }}
          # Si el comando anterior falla por ruta, probamos el estandar:
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey ${{ github.event.inputs.tailscale_key }}

      - name: ‚òÄÔ∏è 4. SUNSHINE & GAMING TOOLS
        shell: powershell
        run: |
          choco install sunshine mesa3d-pal1000 vigembus -y
          Write-Host "[OK] Sunshine, GPU Software y Controles listos."

      - name: üìä 5. DATOS FINALES
        shell: powershell
        run: |
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "========================================"
          Write-Host "LA VM EST√Å VIVA"
          Write-Host "IP PARA MOONLIGHT: $ip"
          Write-Host "URL PANEL SUNSHINE: https://$($ip):47990"
          Write-Host "========================================"

      - name: üîÑ LOOP INFINITO
        run: |
          while($true) { Start-Sleep 60 }
          
